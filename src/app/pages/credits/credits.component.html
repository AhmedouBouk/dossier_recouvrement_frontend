<div class="container">
  <h2>Gestion des Crédits</h2>

  <div class="search-section">
    <input [(ngModel)]="searchTerm" placeholder="Rechercher par ID, Compte ou Statut">
    <button (click)="searchCredits()">Rechercher</button>
    <button *ngIf="hasDORole()" (click)="showAddCreditForm()">Ajouter un Crédit</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>ID Crédit</th>
        <th>ID Compte</th>
        <th>Montant</th>
        <th>Date Début</th>
        <th>Statut</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let credit of credits">
        <td>{{ credit.idCredit }}</td>
        <td>{{ credit.idCompte }}</td>
        <td>{{ credit.montant }}</td>
        <td>{{ credit.dateDebut | date:'dd/MM/yyyy' }}</td>
        <td>{{ credit.statut }}</td>
        <td>
          <button *ngIf="hasDORole()" (click)="viewDetails(credit)">Détails</button>
          <button class="edit-button" *ngIf="hasDORole()" (click)="startEdit(credit)">Modifier</button>
          <button *ngIf="hasDORole()" (click)="deleteCredit(credit.idCredit)">Supprimer</button>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- Formulaire d'ajout -->
  <div *ngIf="showAddForm" class="add-form">
    <h3>Ajouter un Crédit</h3>
    <form (ngSubmit)="addCredit()">
      <input [(ngModel)]="creditForm.idCompte" name="idCompte" placeholder="ID Compte" required>
      <input [(ngModel)]="creditForm.idGarantie" name="idGarantie" placeholder="ID Garantie" required>
      <input [(ngModel)]="creditForm.montant" name="montant" type="number" placeholder="Montant" required>
      <input [(ngModel)]="creditForm.tauxInteret" name="tauxInteret" type="number" step="0.01" placeholder="Taux d'intérêt" required>
      <input [(ngModel)]="creditForm.duree" name="duree" type="number" placeholder="Durée (mois)" required>
      <input [(ngModel)]="creditForm.dateDebut" name="dateDebut" type="date" required>
      <input [(ngModel)]="creditForm.statut" name="statut" placeholder="Statut" required>
      <input [(ngModel)]="creditForm.refTransaction" name="refTransaction" placeholder="Référence Transaction">

      <label>Documents à télécharger</label>
      <input type="file" (change)="onFileSelected($event, 'demande')">
      <input type="file" (change)="onFileSelected($event, 'etude')">
      <input type="file" (change)="onFileSelected($event, 'bulletinSalaire')">
      <input type="file" (change)="onFileSelected($event, 'domiciliation')">
      <input type="file" (change)="onFileSelected($event, 'pvComite')">
      <input type="file" (change)="onFileSelected($event, 'bonPourAval')">
      <input type="file" (change)="onFileSelected($event, 'reconnaissanceDeDette')">
      <input type="file" (change)="onFileSelected($event, 'contrat')">
      <input type="file" (change)="onFileSelected($event, 'tableauAmortissement')">

      <button type="submit">Enregistrer</button>
    </form>
  </div>

  <ng-container *ngIf="editingCredit?.idCredit === credit.idCredit">
    <td colspan="6">
      <div class="edit-form">
        <h3>Mise à jour du Crédit</h3>
        <form (ngSubmit)="updateCredit(editingCredit)">
          <input [(ngModel)]="editingCredit.idCompte" name="idCompte" placeholder="ID Compte" required>
          <input [(ngModel)]="editingCredit.idGarantie" name="idGarantie" placeholder="ID Garantie" required>
          <input [(ngModel)]="editingCredit.montant" name="montant" type="number" placeholder="Montant" required>
          <input [(ngModel)]="editingCredit.tauxInteret" name="tauxInteret" type="number" step="0.01" placeholder="Taux d'intérêt" required>
          <input [(ngModel)]="editingCredit.duree" name="duree" type="number" placeholder="Durée (mois)" required>
          <input [(ngModel)]="editingCredit.dateDebut" name="dateDebut" type="date" required>
          <input [(ngModel)]="editingCredit.statut" name="statut" placeholder="Statut" required>
          <input [(ngModel)]="editingCredit.refTransaction" name="refTransaction" placeholder="Référence Transaction">

          <label>Documents à mettre à jour</label>
          <input type="file" (change)="onFileSelected($event, 'demande')">
          <input type="file" (change)="onFileSelected($event, 'etude')">
          <input type="file" (change)="onFileSelected($event, 'bulletinSalaire')">
          <input type="file" (change)="onFileSelected($event, 'domiciliation')">
          <input type="file" (change)="onFileSelected($event, 'pvComite')">
          <input type="file" (change)="onFileSelected($event, 'bonPourAval')">
          <input type="file" (change)="onFileSelected($event, 'reconnaissanceDeDette')">
          <input type="file" (change)="onFileSelected($event, 'contrat')">
          <input type="file" (change)="onFileSelected($event, 'tableauAmortissement')">

          <button type="submit" class="save-button">Sauvegarder</button>
          <button type="button" class="cancel-button" (click)="cancelEdit()">Annuler</button>
        </form>
      </div>
    </td>
  </ng-container>

  <!-- Détails du crédit -->
  <div *ngIf="selectedCredit" class="credit-details">
    <h3>Détails du Crédit</h3>
    <div *ngFor="let attr of ['idCredit', 'idCompte', 'idGarantie', 'montant', 'tauxInteret', 'duree', 'dateDebut', 'statut', 'refTransaction']">
      <strong>{{ attr }}:</strong> {{ selectedCredit[attr] }}
    </div>

    <h4>Documents</h4>
    <div *ngFor="let doc of ['demande', 'etude', 'bulletinSalaire', 'domiciliation', 'pvComite', 'bonPourAval', 'reconnaissanceDeDette', 'contrat', 'tableauAmortissement']">
      <a (click)="downloadFile(doc)">{{ doc }}</a>
    </div>
  </div>
</div>
