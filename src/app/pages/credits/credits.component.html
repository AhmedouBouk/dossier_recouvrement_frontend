<div class="container">
  <h2>Gestion des Crédits</h2>

  <div class="search-section">
    <input [(ngModel)]="searchTerm" placeholder="Rechercher par ID, Compte ou Statut">
    <button (click)="searchCredits()">Rechercher</button>
    <button *ngIf="creditRoleService.hasRole(['DO'])" (click)="showAddCreditForm()">Ajouter un Crédit</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>ID Crédit</th>
        <th>ID Compte</th>
        <th>Montant</th>
        <th>Date Début</th>
        <th>Statut</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let credit of credits">
        <td>{{ credit.idCredit }}</td>
        <td>{{ credit.idCompte }}</td>
        <td>{{ credit.montant }}</td>
        <td>{{ credit.dateDebut | date:'dd/MM/yyyy' }}</td>
        <td>{{ credit.statut }}</td>
        <td>
          <button *ngIf="creditRoleService.hasRole(['DO'])" (click)="viewDetails(credit)">Détails</button>
          <button class="edit-button" *ngIf="creditRoleService.hasRole(['DO', 'DC'])" (click)="startEdit(credit)">Modifier</button>
          <button *ngIf="creditRoleService.hasRole(['DO'])" (click)="deleteCredit(credit.idCredit)">Supprimer</button>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- Formulaire d'ajout -->
  <div *ngIf="showAddForm" class="add-form">
    <h3>Ajouter un Crédit</h3>
    <form (ngSubmit)="addCredit()">
      <input [(ngModel)]="creditForm.idCompte" name="idCompte" placeholder="ID Compte" required>
      <input [(ngModel)]="creditForm.idGarantie" name="idGarantie" placeholder="ID Garantie" required>
      <input [(ngModel)]="creditForm.montant" name="montant" type="number" placeholder="Montant" required>
      <input [(ngModel)]="creditForm.tauxInteret" name="tauxInteret" type="number" step="0.01" placeholder="Taux d'intérêt" required>
      <input [(ngModel)]="creditForm.duree" name="duree" type="number" placeholder="Durée (mois)" required>
      <input [(ngModel)]="creditForm.dateDebut" name="dateDebut" type="date" required>
      <input [(ngModel)]="creditForm.statut" name="statut" placeholder="Statut" required>
      <input [(ngModel)]="creditForm.refTransaction" name="refTransaction" placeholder="Référence Transaction">

      <label>Documents à télécharger</label>
      <input type="file" (change)="onFileSelected($event, 'demande')">
      <input type="file" (change)="onFileSelected($event, 'etude')">
      <input type="file" (change)="onFileSelected($event, 'bulletinSalaire')">
      <input type="file" (change)="onFileSelected($event, 'domiciliation')">
      <input type="file" (change)="onFileSelected($event, 'pvComite')">
      <input type="file" (change)="onFileSelected($event, 'bonPourAval')">
      <input type="file" (change)="onFileSelected($event, 'reconnaissanceDeDette')">
      <input type="file" (change)="onFileSelected($event, 'contrat')">
      <input type="file" (change)="onFileSelected($event, 'tableauAmortissement')">

      <button type="submit">Enregistrer</button>
    </form>
  </div>

  <!-- Formulaire de modification -->
  <ng-container *ngIf="editingCredit">
    <div class="edit-form">
      <h3>Modifier le Crédit</h3>
      <form (ngSubmit)="updateCredit(editingCredit)">
        <input [(ngModel)]="editingCredit.idCompte" name="idCompte" placeholder="ID Compte" required>
        <input [(ngModel)]="editingCredit.idGarantie" name="idGarantie" placeholder="ID Garantie" required>
        <input [(ngModel)]="editingCredit.montant" name="montant" type="number" placeholder="Montant" required>
        <input [(ngModel)]="editingCredit.tauxInteret" name="tauxInteret" type="number" step="0.01" placeholder="Taux d'intérêt" required>
        <input [(ngModel)]="editingCredit.duree" name="duree" type="number" placeholder="Durée (mois)" required>
        <input [(ngModel)]="editingCredit.dateDebut" name="dateDebut" type="date" required>
        <input [(ngModel)]="editingCredit.statut" name="statut" placeholder="Statut" required>
        <input [(ngModel)]="editingCredit.refTransaction" name="refTransaction" placeholder="Référence Transaction">

        <label>Documents à mettre à jour</label>
        <input type="file" (change)="onFileSelected($event, 'demande')">
        <input type="file" (change)="onFileSelected($event, 'etude')">
        <input type="file" (change)="onFileSelected($event, 'bulletinSalaire')">
        <input type="file" (change)="onFileSelected($event, 'domiciliation')">
        <input type="file" (change)="onFileSelected($event, 'pvComite')">
        <input type="file" (change)="onFileSelected($event, 'bonPourAval')">
        <input type="file" (change)="onFileSelected($event, 'reconnaissanceDeDette')">
        <input type="file" (change)="onFileSelected($event, 'contrat')">
        <input type="file" (change)="onFileSelected($event, 'tableauAmortissement')">

        <button type="submit">Enregistrer</button>
        <button type="button" (click)="cancelEdit()">Annuler</button>
      </form>
    </div>
  </ng-container>
  
  <!-- Détails du crédit -->
  <div *ngIf="selectedCredit" class="credit-details">
    <h3>Détails du Crédit</h3>
    <div>
      <strong>ID Crédit:</strong> {{ selectedCredit.idCredit }}
    </div>
    <div>
      <strong>ID Compte:</strong> {{ selectedCredit.idCompte }}
    </div>
    <div>
      <strong>ID Garantie:</strong> {{ selectedCredit.idGarantie }}
    </div>
    <div>
      <strong>Montant:</strong> {{ selectedCredit.montant }}
    </div>
    <div>
      <strong>Taux d'intérêt:</strong> {{ selectedCredit.tauxInteret }}
    </div>
    <div>
      <strong>Durée:</strong> {{ selectedCredit.duree }}
    </div>
    <div>
      <strong>Date de début:</strong> {{ selectedCredit.dateDebut | date:'dd/MM/yyyy' }}
    </div>
    <div>
      <strong>Statut:</strong> {{ selectedCredit.statut }}
    </div>
    <div>
      <strong>Référence Transaction:</strong> {{ selectedCredit.refTransaction }}
    </div>

    <h4>Documents</h4>
    <div>
      <a (click)="downloadFile('demande')">Demande</a>
    </div>
    <div>
      <a (click)="downloadFile('etude')">Étude</a>
    </div>
    <div>
      <a (click)="downloadFile('bulletinSalaire')">Bulletin de Salaire</a>
    </div>
    <div>
      <a (click)="downloadFile('domiciliation')">Domiciliation</a>
    </div>
    <div>
      <a (click)="downloadFile('pvComite')">PV Comité</a>
    </div>
    <div>
      <a (click)="downloadFile('bonPourAval')">Bon Pour Aval</a>
    </div>
    <div>
      <a (click)="downloadFile('reconnaissanceDeDette')">Reconnaissance de Dette</a>
    </div>
    <div>
      <a (click)="downloadFile('contrat')">Contrat</a>
    </div>
    <div>
      <a (click)="downloadFile('tableauAmortissement')">Tableau d'Amortissement</a>
    </div>
  </div>
</div>